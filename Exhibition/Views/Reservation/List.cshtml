@{
    ViewBag.Title = "預約清單";
}
@section Styles {
    <link rel="stylesheet" href="~/Content/datepicker.css">
    @*<link rel="stylesheet" href="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">*@
    <link rel="stylesheet" href="//ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/css/jquery.dataTables.css">
    @*<link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/css/bootstrapValidator.min.css"/>*@

    @*<link rel="stylesheet" href="//cdn.datatables.net/1.10.0/css/jquery.dataTables.css">*@
    @*<link href="//datatables.net/release-datatables/media/css/demo_table_jui.css" rel="stylesheet" />*@
    <style>
        .colSN {
            /*cursor: pointer;*/
            text-align: center;
        }

        .TRHide {
            display: none;
        }

        .TRSet {
            /*background-color:#EBEBEB;*/
            background-color: #f4f8fa;
        }

        .tableMember {
            text-align: center;
            width: 100%;
        }

            .tableMember th {
                text-align: center;
                font-weight: normal;
            }
        /*.sorting_1 {
            background-color:red;
        }*/
        /*table.dataTable tr.odd td.sorting_1 {
            background-color: white;
        }*/
        .panel-default {
            background-color: #f4f8fa;
            /*background-color:#bce8f1;*/
        }

        .CBCancel {
            font-weight: normal;
        }

        .area1 {
            border: 0px solid;
            padding: 0px 0px 0px 0px;
            background-color: transparent;
            width: 360px;
        }

        #divDate {
            /*height:300px;*/
            background-color: #f4f8fa;
        }

        #ReservationBeginNew {
            margin: 10px 0px 5px 0px;
        }

        .form-group {
            margin-bottom: 5px;
        }

        textarea {
            height: 90px;
            background-color: red;
        }
    </style>
}

<div>
    <h2 class="text-center">預約清單</h2>
    @*<div class="text-center"><button id="BTAdd" type="button" class="btn btn-primary btn-sm"><span class="glyphicon glyphicon-hand-up"></span> 新增預約記錄</button></div>*@
    <table class="table table-condensed table-striped table-hover" id="tableJS">
        @*<table class="display dataTable" id="tableJS">*@
    </table>

    <div class="row">&nbsp;</div>
    <div class="row">&nbsp;</div>


    <div class="row">
        <div class="col-sm-6">
            @using (Html.BeginForm("LogOff", "Account", FormMethod.Post, new { id = "logoutForm" }))
            {
                @Html.AntiForgeryToken()
                <h2 class="label label-success">@ViewBag.User </h2>
                <a href="javascript:document.getElementById('logoutForm').submit()" class="btn btn-primary btn-xs">登出</a>
            }
        </div>
        <div class="col-sm-6 text-right">
            @*<a href="~/GoogleCal/" class="btn btn-danger btn-xs">訂閱預約行事曆</a>*@
        </div>
    </div>
    <div class="row">&nbsp;</div>


    @*<a data-toggle="modal" href="#myModal" class="btn btn-primary btn-lg">Launch demo modal</a>*@

    <!-- Modal -->
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                @* <div class="modal-header">

                    </div>*@
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>
                    <h4 class="modal-title">預約記錄</h4>
                    <table class="table table-hover table-condensed">
                        @*<thead>
                                <tr>
                                    <th>代碼</th>
                                    <th>預約日期</th>
                                    <th>Last Name</th>
                                    <th>Username</th>
                                </tr>
                            </thead>*@
                        <tbody>
                            <tr>
                                <td>代碼</td>
                                <td id="td1">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>預約日期</td>
                                <td id="td2">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>狀態</td>
                                <td id="td3">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>類型</td>
                                <td id="td4">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr class="groups">
                                <td>團體名稱</td>
                                <td id="td6">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>人數</td>
                                <td id="td5">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            @*<tr>
                                    <td>團體類別</td>
                                    <td id="td7"></td>
                                </tr>*@
                            <tr>
                                <td>聯絡人</td>
                                <td id="td8">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>行動電話</td>
                                <td id="td9">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>電子郵件</td>
                                <td id="td10">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>備註</td>
                                <td id="td11">
                                    <pre id="" class="area1 readData"></pre>

                                </td>
                            </tr>
                            <tr>
                                <td>登錄日期</td>
                                <td id="td12">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr>
                                <td>核准日期</td>
                                <td id="tdAuth">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr class="TRHide">
                                <td>修改日期</td>
                                <td id="td13">
                                    <div class="readData"></div>
                                </td>
                            </tr>
                            <tr class="TRSet">
                                <td>實際參訪人數</td>
                                <td id="td14"></td>
                            </tr>
                            <tr class="TRSet">
                                <td>國籍組成</td>
                                <td>
                                    <table class="tableMember">
                                        <thead>
                                            <tr>
                                                <th>本國人數</th>
                                                <th>外籍人數</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td id="TDNationNative"></td>
                                                <td id="TDNationForeigner"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>
                            <tr class="TRSet">
                                <td>類別組成</td>
                                <td>
                                    @*<table class="table table-condensed tableMember">*@
                                    <table class="tableMember">
                                        <thead>
                                            <tr>
                                                <th>政府機關</th>
                                                <th>民間團體</th>
                                                <th>學術組織</th>
                                                <th>其他</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td id="TDMemberGov"></td>
                                                <td id="TDMemberNGO"></td>
                                                <td id="TDMemberEdu"></td>
                                                <td id="TDMemberOther"></td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </td>
                            </tr>

                            <tr class="TRSet">
                                <td>梯次</td>
                                <td id="tdTourNo"></td>
                            </tr>
                            <tr class="TRSet">
                                <td>參訪領隊</td>
                                <td id="tdTourLeader"></td>
                            </tr>
                            <tr class="TRSet">
                                <td>導覽人員</td>
                                <td id="tdTourGuide"></td>
                            </tr>
                            <tr class="TRSet">
                                <td>專業類別</td>
                                <td id="tdTourField"></td>
                            </tr>
                            <tr class="TRSet">
                                <td>管理者備註</td>
                                <td>
                                    <pre id="td15" class="area1"></pre>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                    <div class="text-center">
                        <button type="button" class="btn btn-primary" id="BTAuth">核准通知</button>
                        &nbsp;
                        <button type="button" class="btn btn-danger" id="BTCancel">取消預約</button>
                        &nbsp;
                        <button type="button" class="btn btn-primary" id="BTDate">更改日期</button>
                        &nbsp;
                        <button type="button" class="btn btn-primary" id="BTEdit">資料設定</button>
                        &nbsp;
                        <button type="button" class="btn btn-default" data-dismiss="modal">離開</button>
                    </div>
                    <input type="hidden" value="" name="SN" id="SN" />
                    <input type="hidden" value="" name="ID" id="ID" />
                    <input type="hidden" value="" name="StateCode" id="StateCode" />
                    <input type="hidden" value="" name="ReservationBegin" id="ReservationBegin" />
                </div>
                @*<div class="modal-footer">
                    </div>*@
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>
    <!-- /.modal -->

    <div class="modal fade" id="setModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                @*<div class="modal-header">
                    </div>*@
                <div class="modal-body">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>
                    <h4>資料設定</h4>
                    <div class="panel panel-default ">
                        @*<div class="panel-heading"></div>*@
                        <div class="panel-body text-center">
                            <form class="form-horizontal" role="form" id="form1">
                                <label>預約資料</label>
                                <div class="form-group form-group-sm">
                                    <label for="GroupName" class="col-sm-3 control-label">團體名稱</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="GroupName" name="GroupName" required>
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label class="col-sm-3 control-label" for="TouristRange1">人數</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TouristRange1" name="TouristRange1" required>
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label class="col-sm-3 control-label" for="ContactName">聯絡人</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="ContactName" name="ContactName" required>
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label class="col-sm-3 control-label" for="ContactMobile">行動電話</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="ContactMobile" name="ContactMobile" required>
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label class="col-sm-3 control-label" for="ContactEmail">電子郵件</label>
                                    <div class="col-sm-6">
                                        <input type="email" class="form-control" id="ContactEmail" name="ContactEmail" required>
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label class="col-sm-3 control-label" for="ContactNote">備註</label>
                                    <div class="col-sm-6">
                                        @*<input type="text" class="form-control" id="ContactNote">*@
                                        <textarea class="form-control" id="ContactNote" rows="6"></textarea>
                                    </div>
                                </div>

                                <hr />

                                <label>實際參訪人數</label>
                                <div class="form-group form-group-sm">
                                    @*<label for="TouristNo" class="col-lg-3 control-label">實際參訪人數</label>*@
                                    <div class="col-sm-3"></div>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TouristNo" placeholder="人數">
                                    </div>
                                </div>

                                <label class="">國籍組成</label>
                                <div class="form-group form-group-sm">
                                    <label for="NationNative" class="col-sm-3 control-label">本國人數</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="NationNative" placeholder="人數">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="NationForeigner" class="col-sm-3 control-label">外籍人數</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="NationForeigner" placeholder="人數">
                                    </div>
                                </div>

                                <label class="">類別組成</label>
                                <div class="form-group form-group-sm">
                                    <label for="MemberGov" class="col-sm-3 control-label">政府機關</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="MemberGov" placeholder="人數">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="MemberNGO" class="col-sm-3 control-label">民間團體</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="MemberNGO" placeholder="人數">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="MemberEdu" class="col-sm-3 control-label">學術組織</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="MemberEdu" placeholder="人數">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="MemberOther" class="col-sm-3 control-label">其他</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="MemberOther" placeholder="人數">
                                    </div>
                                </div>
                                <hr />
                                <label>管理者備註</label>
                                <div class="form-group form-group-sm">
                                    <label for="TourNo" class="col-sm-3 control-label">梯次</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TourNo" placeholder="">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="TourLeader" class="col-sm-3 control-label">參訪領隊</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TourLeader" placeholder="">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="TourGuide" class="col-sm-3 control-label">導覽人員</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TourGuide" placeholder="">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    <label for="TourField" class="col-sm-3 control-label">專業類別</label>
                                    <div class="col-sm-6">
                                        <input type="text" class="form-control" id="TourField" placeholder="">
                                    </div>
                                </div>
                                <div class="form-group form-group-sm">
                                    @*<div class="col-lg-12">*@
                                    @*<label for="inputPassword1" class="col-sm-3 control-label">管理者備註</label>*@
                                    <div class="col-sm-offset-3 col-sm-6">
                                        <textarea class="form-control" id="Note" placeholder="管理者備註" rows="3"></textarea>
                                    </div>
                                </div>
                                @*<button type="button" class="btn btn-primary" id="BTSave">儲存</button>*@
                                <button type="submit" class="btn btn-primary" id="BTSave">儲存</button>
                                &nbsp;
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>

                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="dateModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                @*<div class="modal-header">
                    </div>*@
                <div class="modal-body modalDate">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove"></span></button>
                    <h4>變更預約日期</h4>
                    <div id="divDate"></div>
                    @*<div class="form-group">*@
                    <div class="row">
                        @*<label for="ReservationBeginNew" class="col-sm-3 control-label">預約日期</label>*@
                        <div class="col-sm-3"></div>
                        <div class="col-sm-6">
                            <input type="text" class="form-control text-center" id="ReservationBeginNew" readonly>
                        </div>
                        <div class="col-sm-3"></div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <label for="optionsAm">
                                <input type="radio" name="optionsTime" id="optionsAm" value="am">
                                上午
                            </label>
                            &nbsp;
                            <label>
                                <input type="radio" name="optionsTime" id="optionsPm" value="pm">
                                下午
                            </label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-12 text-center">
                            <div>@*(請自行確認該日期是否衝突)*@ &nbsp;</div>
                            <button type="button" class="btn btn-primary" id="BTSaveDate">變更</button>
                            &nbsp;
                            <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @*<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>*@
    @*<script src="http://momentjs.com/downloads/moment.min.js"></script>*@
    @*<script src="http://cdnjs.cloudflare.com/ajax/libs/numeral.js/1.5.0/numeral.min.js"></script>*@

    @*<script src="http://ajax.aspnetcdn.com/ajax/jquery.dataTables/1.9.4/jquery.dataTables.min.js"></script>*@
    <script src="//cdn.datatables.net/1.10.0/js/jquery.dataTables.js"></script>
    <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/jquery.bootstrapvalidator/0.5.0/js/bootstrapValidator.min.js"></script>

    @Scripts.Render("~/Scripts/moment.min.js")
    @Scripts.Render("~/Scripts/bootstrap-datepicker.js")
    @Scripts.Render("~/Scripts/bootstrap-datepicker.zh-TW.js")
    <script type="text/javascript">
        var timeAM_1 = '10:00';
        var timeAM_2 = '12:00';
        var timePM_1 = '13:10';
        var timePM_2 = '16:00';

        $(document).ready(function () {
            //var colState;
            var aPos = -1;
            $('#tableJS').on("click", "tbody tr", function () {
                aPos = table1.fnGetPosition(this);
            });

            $('#tableJS').on("click", ".SN", function () {
                //colState = $(this).parent().parent().find('.colState').eq(0);
                var sn = Number($(this).text());
                GetRowData(sn);
                $('#myModal').modal();
            });

            var today = new Date();
            $('#dateModal').on('shown.bs.modal', function (e) {
                //$('#offday').datepicker({
                //    format: "yyyy/mm/dd",
                //    language: "zh-TW"
                //});
                var date = moment($('#ReservationBegin').val());
                //$('#optionsAm').attr('checked', false);
                //$('#optionsPm').attr('checked', false);

                if (date.hour() < 12)
                    $('#optionsAm').prop('checked', true);
                    //$("input[name=optionsTime]").val('am');
                else
                    $('#optionsPm').prop('checked', true);
                //$("input[name=optionsTime]").val('pm');
                $('#ReservationBeginNew').val(date.format('YYYY-MM-DD'));


                $('#divDate').datepicker({
                    language: "zh-TW",
                    //startDate: today
                    startDate: '2020-01-01'
                }).on('changeDate', function (e) {
                    //alert(e.date);
                    $('#ReservationBeginNew').val(moment(e.date).format("YYYY-MM-DD"));
                    //var newDate = new Date(e.date);
                });
                $('#divDate').datepicker('update', date.format('YYYY-MM-DD'));
            })


            $('#BTSaveDate').click(function () {
                //var date1 = moment($('#ReservationBeginNew').val());
                //var date2 = moment($('#ReservationBeginNew').val());
                var time = $("input[name=optionsTime]:checked").val();
                var dateStr1, dateStr2;
                if (time == "am") {
                    //dateStr1 = calEvent.start.getFullYear() + '-' + (calEvent.start.getMonth() + 1) + '-' + calEvent.start.getDate() + ' ' + timeAM_1;
                    //dateStr2 = calEvent.start.getFullYear() + '-' + (calEvent.start.getMonth() + 1) + '-' + calEvent.start.getDate() + ' ' + timeAM_2;

                    //date1 = moment($('#ReservationBeginNew').val() + ' ' + timeAM_1);
                    //date2 = moment($('#ReservationBeginNew').val() + ' ' + timeAM_2);

                    dateStr1 = $('#ReservationBeginNew').val() + ' ' + timeAM_1;
                    dateStr2 = $('#ReservationBeginNew').val() + ' ' + timeAM_2;

                } else if (time == "pm") {
                    //dateStr1 = calEvent.start.getFullYear() + '-' + (calEvent.start.getMonth() + 1) + '-' + calEvent.start.getDate() + ' ' + timePM_1;
                    //dateStr2 = calEvent.start.getFullYear() + '-' + (calEvent.start.getMonth() + 1) + '-' + calEvent.start.getDate() + ' ' + timePM_2;

                    //date1 = moment($('#ReservationBeginNew').val() + ' ' + timePM_1);
                    //date2 = moment($('#ReservationBeginNew').val() + ' ' + timePM_2);

                    dateStr1 = $('#ReservationBeginNew').val() + ' ' + timePM_1;
                    dateStr2 = $('#ReservationBeginNew').val() + ' ' + timePM_2;
                }

                if (confirm('確定變更預約日期？(※請自行確認該時段是否衝突※)')) {
                    var id = $('#ID').val();
                    var sn = $('#SN').val();
                    $.ajax({
                        url: 'ChangeReservationDate',
                        dataType: 'json',
                        data: {
                            id: id,
                            begin: dateStr1,
                            end: dateStr2
                        },
                        type: 'POST'
                    }).done(function (rows) {
                        AddAuthEvent(id);
                        GetRowData(sn);
                        UpdateTableRow();
                        alert('變更成功！');
                        $('#dateModal').modal('hide');
                    }).fail(function () {
                        alert("error!");
                    });
                }
            });

            //$('#d1 .input-group.date').datepicker({
            //    language: "zh-TW"
            //});

            //$('#tableJS').on("click", "td", function () {

            // Get the position of the current data from the node
            //var aPos = table1.fnGetPosition(this);
            // Get the data array for this row

            //var aData = table1.fnGetData(0, 1);
            //alert(aData);


            // Update the data array and return the value
            //aData[aPos[1]] = 'clicked';
            //this.innerHTML = 'clicked';
            //});

            var rowStateCode;
            function GetRowData(sn) {
                $.ajax({
                    url: 'ListSingle',
                    dataType: 'json',
                    data: {
                        sn: sn
                    },
                    type: 'POST'
                }).done(function (rows) {
                    if (rows.length == 1) {
                        $('.readData').show();
                        $('.editData').hide();

                        var data = rows[0];
                        var type;
                        //var range = '';
                        if (data.TouristType == '1') {
                            //range = data.TouristRange1;
                            type = '個人';
                            $('.groups').hide();
                        }
                        else if (data.TouristType == '2') {
                            //range = data.TouristRange1 + '~' + data.TouristRange2;
                            type = '團體';
                            $('.groups').show();
                        }
                        var code = '0000' + data.SN;
                        code = code.substr(code.length - 5, 5);
                        //var state = '';
                        //if (data.VerifyDate)
                        //    state = '已認證';

                        $('#td1 .readData').text(code);
                        var d = moment(data.ReservationBegin);
                        var t = "上午";
                        if (d.hours() >= 12)
                            t = "下午";
                        $('#td2 .readData').text(d.format("YYYY-MM-DD") + " " + t);
                        //$('#td3').text(state);
                        $('#td3 .readData').text((data.StateCodeName || ''));
                        $('#td4 .readData').text(type);
                        //$('#td5').text(range);
                        $('#td5 .readData').text(data.TouristRange1);
                        $('#td6 .readData').text((data.GroupName || ''));
                        $('#td7 .readData').text((data.GroupTypeName || ''));
                        $('#td8 .readData').text((data.ContactName || ''));
                        $('#td9 .readData').text((data.ContactMobile || ''));
                        $('#td10 .readData').text((data.ContactEmail || ''));
                        $('#td11 .readData').text(data.ContactNote || '');
                        $('#td12 .readData').text(moment(data.CreateDate).format("YYYY-MM-DD"));
                        $('#td13 .readData').text(data.ModifyDate ? moment(data.ModifyDate).format("YYYY-MM-DD HH:mm") : '');
                        //$('#td14').text(data.TouristNo || '');

                        $('#td14').text(data.TouristNo != null ? data.TouristNo : '');
                        $('#td15').text(data.Note || '');
                        //$('#TouristNo').val(data.TouristNo);
                        //$('#Note').val(data.Note);
                        $('#tdTourNo').text(data.TourNo || '');
                        $('#tdTourLeader').text(data.TourLeader || '');
                        $('#tdTourGuide').text(data.TourGuide || '');
                        $('#tdTourField').text(data.TourField || '');

                        $('#SN').val(data.SN);
                        $('#ID').val(data.ID);

                        $('#TDNationForeigner').text(data.NationForeigner || '');
                        $('#TDNationNative').text(data.NationNative || '');

                        $('#TDMemberGov').text(data.MemberGov || '');
                        $('#TDMemberNGO').text(data.MemberNGO || '');
                        $('#TDMemberEdu').text(data.MemberEdu || '');
                        $('#TDMemberOther').text(data.MemberOther || '');

                        $('#ReservationBegin').val(moment(data.ReservationBegin));

                        $('#tdAuth').text(data.AuthDate ? moment(data.AuthDate).format("YYYY-MM-DD") : '');


                        rowStateCode = data.StateCode;

                        if (data.StateCode == '20') {
                            $('#BTCancel').text('取消預約');
                            $('#BTCancel').removeClass('btn-primary');
                            $('#BTCancel').addClass('btn-danger');

                            $('#BTAuth').prop('disabled', false);
                        }
                        else {
                            $('#BTCancel').text('認證預約');
                            $('#BTCancel').removeClass('btn-danger');
                            $('#BTCancel').addClass('btn-primary');

                            //$('#BTAuth').attr('disabled', 'disabled');
                            $('#BTAuth').prop('disabled', true);
                        }

                        //var html =
                        //    '<dt>預約代碼：</dt><dd>' + sn + '</dd>' +
                        //    '<dt>預約日期：</dt><dd>' +  + '</dd>' +
                        //    '<dt>預約時段：</dt><dd>' + moment(data.ReservationBegin).format("HH:mm") + '~' + moment(data.ReservationEnd).format("HH:mm") + '</dd>' +
                        //    '<dt>參觀人數：</dt><dd>' + range + '</dd>' +
                        //    group +
                        //    '<dt>聯絡人姓名：</dt><dd>' + data.ContactName + '</dd>' +
                        //    '<dt>行動電話：</dt><dd>' + data.ContactMobile + '</dd>' +
                        //    '<dt>電子郵件：</dt><dd>' + data.ContactEmail + '</dd>' +
                        //    '<dt>備註：</dt><dd>' + (data.ContactNote || '') + '</dd>'
                        //;
                    } else {
                        alert("查無資料");
                    }

                }).fail(function () {
                    alert("系統錯誤！");
                });
            }

            ListAll();
            function ListAll() {
                $.ajax({
                    url: 'ListAll',
                    dataType: 'json',
                    type: 'POST'
                }).done(function (data) {
                    var rows = new Array();
                    $.each(data, function (key, value) {
                        /*
                        var row = new Array();
                        var code = '0000' + value.SN;
                        row.push('<button type="button" class="btn btn-primary btn-xs SN">' + code.substr(code.length - 5) + '</button>');
                        //row.push(moment(value.ReservationBegin).format("YYYY-MM-DD") + ' ' + moment(value.ReservationBegin).format("HH:mm") + '~' + moment(value.ReservationEnd).format("HH:mm"));

                        var d = moment(value.ReservationBegin);
                        var t = "上午";
                        if (d.hours() >= 12)
                            t = "下午";
                        row.push(d.format("YYYY-MM-DD") + ' ' + t);
                        //if (value.VerifyDate)
                        //    row.push("已認證");
                        //else
                        //    row.push("");

                        //var name = (value.StateCodeName || '新登錄');
                        var name = value.StateCodeName;
                        row.push(name);

                        var touristTypeName = '';
                        //var range = '';
                        if (value.TouristType == '1') {
                            touristTypeName = "個人";
                            //range = value.TouristRange1;
                        }
                        else if (value.TouristType == '2') {
                            touristTypeName = "團體";
                            //range = value.TouristRange1 + '~' + value.TouristRange2;
                        }
                        row.push(touristTypeName);
                        row.push(value.ContactName || '');
                        //row.push((value.TouristRange1 || '') + (value.TouristRange2 ? '~' + value.TouristRange2 : ''));
                        //row.push(range);
                        row.push(value.TouristRange1);
                        var groupName = '';
                        if (value.GroupName)
                            groupName = value.GroupName + ":";
                        //row.push(value.ContactMobile || '');
                        //row.push(value.ContactEmail || '');
                        //row.push(value.ContactNote || '');
                        //row.push(moment(value.CreateDate).format("YYYY-MM-DD"));
                        row.push(value.TouristNo);
                        rows.push(row);
                        */
                        rows.push(GetTableRow(value));
                    });
                    DataTableJS(rows);
                });
            }

            var table1;
            function DataTableJS(data) {
                table1 = $('#tableJS').dataTable({
                    "aaData": data,
                    "aoColumns": [
                        { "sTitle": "代碼", "sClass": "colSN", "sWidth": "90px" },
                        //{ "sTitle": "預約日期", "sWidth": "180px" },
                        { "sTitle": "預約日期" , "sWidth": "130px"},
                        { "sTitle": "狀態", "sClass": "colSN colState", "sWidth": "90px" },
                        { "sTitle": "核准日期" , "sWidth": "110px"},
                        //{ "sTitle": "類型", "sClass": "colSN" },
                        { "sTitle": "團體" },
                        { "sTitle": "聯絡人" , "sWidth": "150px"},
                        { "sTitle": "預約<br>人數", "sClass": "colSN" , "sWidth": "80px"},
                        { "sTitle": "實際<br>人數", "sClass": "colSN" , "sWidth": "80px"}
                        //{ "sTitle": "行動電話" },
                        //{ "sTitle": "電子郵件" },
                        //{ "sTitle": "備註" },
                        //{ "sTitle": "登錄日期", "iDataSort": 1 }
                    ],
                    "lengthMenu": [[15, 30, 60, -1], [15, 30, 60, "All"]],
                    //"aaSorting": [[0, 'desc']],
                    "aaSorting": [[1, 'desc']],
                    //"bJQueryUI": true,
                    //"asStripeClasses": ['gradeA even', 'gradeA odd'],
                    "sPaginationType": "full_numbers",
                    //"sAjaxSource": "TenderLink.ashx",
                    "oLanguage": {
                        "sLengthMenu": "每頁顯示筆數： _MENU_ ",
                        "sZeroRecords": "無資料",
                        "sInfo": "本頁資料：第 _START_ 至第 _END_ 筆 , 共 _TOTAL_ 筆",
                        //"sInfoEmpty": "Showing 0 to 0 of 0 records",
                        "sInfoEmpty": "無資料",
                        "sInfoFiltered": "(已篩選 , 總筆數 _MAX_)",
                        "sSearch": "篩選：",
                        "sProcessing": "處理中......",
                        "oPaginate": {
                            "sFirst": "首頁",
                            "sPrevious": "上頁",
                            "sNext": "下頁",
                            "sLast": "末頁"
                        }
                    }
                });

                //$.fn.dataTableExt.oStdClasses.sSortColumn = "aaa";
                //$.fn.dataTableExt.oJUIClasses.sSortColumn = "aaa";

                $('#tableJS_filter').append(' <input id="CBCancel" type="checkbox" /> <label for="CBCancel" class="CBCancel">顯示取消記錄</label>');
                table1.fnFilter('新登錄|已認證', 2, true, true);

                $('#CBCancel').click(function () {
                    if ($('#CBCancel:checked').length == 1)
                        table1.fnFilter('', 2);
                    else
                        table1.fnFilter('新登錄|已認證', 2, true, true);
                });
            }



            $('#setModal').on('shown.bs.modal', function (e) {
                $('#form1').data('bootstrapValidator').resetForm();
            })

            //$('#BTSave').click(function () {
            //    SetData();
            //});
            $('#form1').bootstrapValidator({
                feedbackIcons: {
                    valid: 'glyphicon glyphicon-ok',
                    invalid: 'glyphicon glyphicon-remove',
                    validating: 'glyphicon glyphicon-refresh'
                },
                fields: {
                    GroupName: {
                        validators: {
                            notEmpty: {
                                // enabled is true, by default
                                message: '請輸入團體名稱！'
                            }
                        }
                    },
                    TouristRange1: {
                        trigger: 'blur',
                        validators: {
                            notEmpty: {
                                // enabled is true, by default
                                message: '請輸入人數！'
                            },
                            integer: {
                                message: '數字格式有誤！'
                            }
                            ,
                            between: {
                                min: 0,
                                max: 1000,
                                message: '數字格式有誤！'
                            }
                        }
                    },
                    ContactName: {
                        validators: {
                            notEmpty: {
                                // enabled is true, by default
                                message: '請輸入聯絡人！'
                            }
                        }
                    },
                    ContactMobile: {
                        trigger: 'blur',
                        validators: {
                            notEmpty: {
                                // enabled is true, by default
                                message: '請輸入行動電話！'
                            },
                            regexp: {
                                regexp: /^\d{10}$/,
                                message: '行動電話格式有誤！'
                            }
                            //,
                            //stringLength: {
                            //    min: 10,
                            //    max: 10,
                            //    message: '行動電話格式有誤！'
                            //}
                        }
                    },
                    ContactEmail: {
                        trigger: 'blur',
                        validators: {
                            notEmpty: {
                                // enabled is true, by default
                                message: '請輸入電子郵件！'
                            },
                            emailAddress: {
                                message: '電子郵件格式有誤！'
                            }
                        }
                    }
                }
            }).on('success.form.bv', function (e) {
                // Prevent form submission
                e.preventDefault();
                SetData();
            });

            function SetData() {
                var no;
                if ($('#TouristNo').val().replace(/\s/g, '').length == 0)
                    no = null;
                else {
                    no = Number($('#TouristNo').val());
                    if (isNaN(no) || no < 0) {
                        alert('請輸入正確人數！');
                        return;
                    }
                }

                var NationForeigner = Number($('#NationForeigner').val());
                var NationNative = Number($('#NationNative').val());
                var MemberGov = Number($('#MemberGov').val());
                var MemberNGO = Number($('#MemberNGO').val());
                var MemberEdu = Number($('#MemberEdu').val());
                var MemberOther = Number($('#MemberOther').val());

                var TourNo = $('#TourNo').val().replace(/\s/g, '');
                var TourLeader = $('#TourLeader').val().replace(/\s/g, '');
                var TourGuide = $('#TourGuide').val().replace(/\s/g, '');
                var TourField = $('#TourField').val().replace(/\s/g, '');

                var GroupName = $('#GroupName').val();
                var TouristRange1 = $('#TouristRange1').val();
                var ContactName = $('#ContactName').val();
                var ContactMobile = $('#ContactMobile').val();
                var ContactEmail = $('#ContactEmail').val();
                var ContactNote = $('#ContactNote').val();

                var note = $('#Note').val();
                var id = $('#ID').val();
                $.ajax({
                    url: 'UpdateReservation',
                    dataType: 'json',
                    data: {
                        id: id,
                        touristNo: no,
                        note: note,
                        NationForeigner: NationForeigner,
                        NationNative: NationNative,
                        MemberGov: MemberGov,
                        MemberNGO: MemberNGO,
                        MemberEdu: MemberEdu,
                        MemberOther: MemberOther,
                        TourNo: TourNo,
                        TourLeader: TourLeader,
                        TourGuide: TourGuide,
                        TourField: TourField,
                        GroupName: GroupName,
                        TouristRange1: TouristRange1,
                        ContactName: ContactName,
                        ContactMobile: ContactMobile,
                        ContactEmail: ContactEmail,
                        ContactNote: ContactNote
                    },
                    type: 'POST'
                }).done(function (data) {
                    if (data.toString() == '1') {
                        GetRowData($('#SN').val());
                        UpdateTableRow();
                    }
                    else {
                        alert('設定失敗！');
                    }
                    $('#setModal').modal('hide');
                }
                ).error(function () {
                    alert("error!");
                });
            }



            $('#BTEdit').click(function () {
                $('#TouristNo').val($('#td14').text());
                $('#Note').val($('#td15').text());

                $('#NationForeigner').val($('#TDNationForeigner').text());
                $('#NationNative').val($('#TDNationNative').text());
                $('#MemberGov').val($('#TDMemberGov').text());
                $('#MemberNGO').val($('#TDMemberNGO').text());
                $('#MemberEdu').val($('#TDMemberEdu').text());
                $('#MemberOther').val($('#TDMemberOther').text());

                $('#TourNo').val($('#tdTourNo').text());
                $('#TourLeader').val($('#tdTourLeader').text());
                $('#TourGuide').val($('#tdTourGuide').text());
                $('#TourField').val($('#tdTourField').text());

                $('#GroupName').val($('#td6 .readData').text());
                $('#TouristRange1').val($('#td5 .readData').text());
                $('#ContactName').val($('#td8 .readData').text());
                $('#ContactMobile').val($('#td9 .readData').text());
                $('#ContactEmail').val($('#td10 .readData').text());
                $('#ContactNote').val($('#td11 .readData').text());

                $('#setModal').modal();

                //$('#form1').data('bootstrapValidator').resetForm();
                //$('#form1').data('bootstrapValidator').validate();
            });

            $('#BTDate').click(function () {
                $('#dateModal').modal();
            });

            $('#NationForeigner').change(function () {
                var no = Number($('#TouristNo').val());
                var NationForeigner = Number($('#NationForeigner').val());
                if (!isNaN(no) && !isNaN(NationForeigner)) {
                    $('#NationNative').val(no - NationForeigner);
                }
            });
            $('#NationNative').change(function () {
                var no = Number($('#TouristNo').val());
                var NationNative = Number($('#NationNative').val());
                if (!isNaN(no) && !isNaN(NationNative)) {
                    $('#NationForeigner').val(no - NationNative);
                }
            });

            $('#MemberGov').change(function () {
                MemberChange();
            });
            $('#MemberNGO').change(function () {
                MemberChange();
            });
            $('#MemberEdu').change(function () {
                MemberChange();
            });
            function MemberChange() {
                var no = Number($('#TouristNo').val());
                var MemberGov = Number($('#MemberGov').val());
                var MemberNGO = Number($('#MemberNGO').val());
                var MemberEdu = Number($('#MemberEdu').val());
                if (!isNaN(no) && !isNaN(MemberGov) && !isNaN(MemberNGO) && !isNaN(MemberEdu)) {
                    var other = no - MemberGov - MemberNGO - MemberEdu;
                    if (other > 0)
                        $('#MemberOther').val(other);
                    else
                        $('#MemberOther').val('');
                }
            }

            $('#BTCancel').click(function () {
                var id = $('#ID').val();
                var sn = $('#SN').val();

                if (rowStateCode == '20') {
                    if (confirm('確定「取消」本次預約？')) {
                        $.ajax({
                            url: 'CancelReservation',
                            dataType: 'json',
                            data: {
                                id: id
                            },
                            type: 'POST'
                        }).done(function (rows) {
                            DeleteAuthEvent(id);
                            GetRowData(sn);
                            //$('#BTCancel').attr('disabled', 'disabled');
                            $('#BTCancel').text('認證預約');
                            $('#BTCancel').removeClass('btn-danger');
                            $('#BTCancel').addClass('btn-primary');
                            //colState.text('已取消');//not complete!
                            UpdateTableRow();
                            alert('取消成功！');
                        }).fail(function () {
                            alert("error!");
                        });
                    }
                } else {
                    if (confirm('確定「認證」本次預約？')) {
                        $.ajax({
                            url: 'VerifyReservation',
                            dataType: 'json',
                            data: {
                                id: id
                            },
                            type: 'POST'
                        }).done(function (rows) {
                            AddAuthEvent(id);
                            GetRowData(sn);
                            $('#BTCancel').text('取消預約');
                            $('#BTCancel').removeClass('btn-primary');
                            $('#BTCancel').addClass('btn-danger');
                            //colState.text('已認證');
                            UpdateTableRow();
                            alert('認證成功！');
                        }).fail(function () {
                            alert("error!");
                        });
                    }
                }
            });

            function GetTableRow(value) {
                var row = new Array();
                var code = '0000' + value.SN;
                row.push('<button type="button" class="btn btn-primary btn-xs SN">' + code.substr(code.length - 5) + '</button>');
                var d = moment(value.ReservationBegin);
                var t = "上午";
                if (d.hours() >= 12)
                    t = "下午";
                row.push(d.format("YYYY-MM-DD") + ' ' + t);

                var name = value.StateCodeName;
                row.push(name);

                if (value.AuthDate) {
                    row.push(moment(value.AuthDate).format("YYYY-MM-DD"));
                } else {
                    row.push('');
                }

                //var touristTypeName = '';
                //if (value.TouristType == '1') {
                //    touristTypeName = "個人";
                //}
                //else if (value.TouristType == '2') {
                //    touristTypeName = "團體";
                //}
                //row.push(touristTypeName);

                row.push(value.GroupName || '');

                row.push(value.ContactName || '');
                row.push(value.TouristRange1);
                var groupName = '';
                if (value.GroupName)
                    groupName = value.GroupName + ":";
                row.push(value.TouristNo);
                //rows.push(row);

                return row;
            }

            function UpdateTableRow() {
                var sn = $('#SN').val();
                if (aPos > -1 && sn > 0) {
                    //alert(aPos + ',' + sn);
                    $.ajax({
                        url: 'ListAllOne',
                        dataType: 'json',
                        data: {
                            sn: sn
                        },
                        type: 'POST'
                    }).done(function (data) {
                        if (data.length == 1) {
                            var row = GetTableRow(data[0]);
                            table1.fnUpdate(row, aPos);
                        }
                    });
                }
            }


            $('#BTAuth').click(function () {
                if (confirm('確定發出核准通知信件？')) {
                    var id = $('#ID').val();
                    var sn = $('#SN').val();
                    $.ajax({
                        url: 'AuthReservation',
                        dataType: 'json',
                        data: {
                            id: id
                        },
                        type: 'POST'
                    }).done(function (data) {
                        if (data == '1') {
                            AddAuthEvent(id);
                            GetRowData(sn);
                            UpdateTableRow();
                            alert('通知成功！');
                        } else {
                            alert('通知郵件發送失敗！請稍後再試。');
                        }
                    }).fail(function () {
                        alert("error!");
                    });
                }
            });

            function AddAuthEvent(id) {
                $.ajax({
                    cache: false,
                    url: '@Url.Content("~/GoogleCal/AddEvent")',
                    data: {
                        type: 'auth',
                        id: id
                    }
                });
            }

            function DeleteAuthEvent(id) {
                $.ajax({
                    cache: false,
                    url: '@Url.Content("~/GoogleCal/DeleteEvent")',
                    data: {
                        id: id
                    }
                });
            }


        });
    </script>
}